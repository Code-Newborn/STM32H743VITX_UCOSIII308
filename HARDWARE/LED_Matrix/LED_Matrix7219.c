#include "LED_Matrix7219.h"
#include "gpio.h"
#include "delay.h"

uint8_t code_disp1[38][8] = {
    {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C}, // 0
    {0x10, 0x18, 0x14, 0x10, 0x10, 0x10, 0x10, 0x10}, // 1
    {0x7E, 0x2, 0x2, 0x7E, 0x40, 0x40, 0x40, 0x7E},   // 2
    {0x3E, 0x2, 0x2, 0x3E, 0x2, 0x2, 0x3E, 0x0},      // 3
    {0x8, 0x18, 0x28, 0x48, 0xFE, 0x8, 0x8, 0x8},     // 4
    {0x3C, 0x20, 0x20, 0x3C, 0x4, 0x4, 0x3C, 0x0},    // 5
    {0x3C, 0x20, 0x20, 0x3C, 0x24, 0x24, 0x3C, 0x0},  // 6
    {0x3E, 0x22, 0x4, 0x8, 0x8, 0x8, 0x8, 0x8},       // 7
    {0x0, 0x3E, 0x22, 0x22, 0x3E, 0x22, 0x22, 0x3E},  // 8
    {0x3E, 0x22, 0x22, 0x3E, 0x2, 0x2, 0x2, 0x3E},    // 9
    {0x8, 0x14, 0x22, 0x3E, 0x22, 0x22, 0x22, 0x22},  // A
    {0x3C, 0x22, 0x22, 0x3E, 0x22, 0x22, 0x3C, 0x0},  // B
    {0x3C, 0x40, 0x40, 0x40, 0x40, 0x40, 0x3C, 0x0},  // C
    {0x7C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x7C, 0x0},  // D
    {0x7C, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x7C}, // E
    {0x7C, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x40}, // F
    {0x3C, 0x40, 0x40, 0x40, 0x40, 0x44, 0x44, 0x3C}, // G
    {0x44, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44, 0x44}, // H
    {0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x7C}, // I
    {0x3C, 0x8, 0x8, 0x8, 0x8, 0x8, 0x48, 0x30},      // J
    {0x0, 0x24, 0x28, 0x30, 0x20, 0x30, 0x28, 0x24},  // K
    {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7C}, // L
    {0x81, 0xC3, 0xA5, 0x99, 0x81, 0x81, 0x81, 0x81}, // M
    {0x0, 0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x0},   // N
    {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C}, // O
    {0x3C, 0x22, 0x22, 0x22, 0x3C, 0x20, 0x20, 0x20}, // P
    {0x1C, 0x22, 0x22, 0x22, 0x22, 0x26, 0x22, 0x1D}, // Q
    {0x3C, 0x22, 0x22, 0x22, 0x3C, 0x24, 0x22, 0x21}, // R
    {0x0, 0x1E, 0x20, 0x20, 0x3E, 0x2, 0x2, 0x3C},    // S
    {0x0, 0x3E, 0x8, 0x8, 0x8, 0x8, 0x8, 0x8},        // T
    {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x22, 0x1C}, // U
    {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18}, // V
    {0x0, 0x49, 0x49, 0x49, 0x49, 0x2A, 0x1C, 0x0},   // W
    {0x0, 0x41, 0x22, 0x14, 0x8, 0x14, 0x22, 0x41},   // X
    {0x41, 0x22, 0x14, 0x8, 0x8, 0x8, 0x8, 0x8},      // Y
    {0x0, 0x7F, 0x2, 0x4, 0x8, 0x10, 0x20, 0x7F},     // Z
    {0x8, 0x7F, 0x49, 0x49, 0x7F, 0x8, 0x8, 0x8},     // ??
    {0xFE, 0xBA, 0x92, 0xBA, 0x92, 0x9A, 0xBA, 0xFE}, // ??
};

void Write_Max7219_byte(uint8_t byte)
{
    HAL_GPIO_WritePin(LED_Matrix_CS_GPIO_Port, LED_Matrix_CS_Pin, GPIO_PIN_RESET);
    for (int i = 0; i < 8; i++)
    {
        HAL_GPIO_WritePin(LED_Matrix_CLK_GPIO_Port, LED_Matrix_CLK_Pin, GPIO_PIN_RESET); // Pull the CLK LOW

        if ((byte & 0x80) == 0) // 写成Max7219_pinDIN = data & 0x80;实测无效，Max7219_pinDIN一直是低电平
        {
            HAL_GPIO_WritePin(LED_Matrix_DIN_GPIO_Port, LED_Matrix_DIN_Pin, GPIO_PIN_RESET); // Write one BIT data MSB first
        }
        else
        {
            HAL_GPIO_WritePin(LED_Matrix_DIN_GPIO_Port, LED_Matrix_DIN_Pin, GPIO_PIN_SET); // Write one BIT data MSB first
        }
        byte = byte << 1;                                                              // shift the data to the left
        HAL_GPIO_WritePin(LED_Matrix_CLK_GPIO_Port, LED_Matrix_CLK_Pin, GPIO_PIN_SET); // Pull the CLK HIGH
    }
}

void Write_Max7219(uint8_t address, uint8_t data)
{
    HAL_GPIO_WritePin(LED_Matrix_CS_GPIO_Port, LED_Matrix_CS_Pin, GPIO_PIN_RESET); // Pull the CS pin LOW
    Write_Max7219_byte(address);                                                   //  write address
    delay_us(10);
    Write_Max7219_byte(data); //  write data
    delay_us(10);
    HAL_GPIO_WritePin(LED_Matrix_CS_GPIO_Port, LED_Matrix_CS_Pin, GPIO_PIN_SET); // pull the CS HIGH
}

void Max7219_init(void)
{
    Write_Max7219(0x09, 0x00); //  no decoding
    Write_Max7219(0x0a, 0x01); //  brightness intensity
    Write_Max7219(0x0b, 0x07); //  scan limit = 8 LEDs
    Write_Max7219(0x0c, 0x01); //  power down =0，normal mode = 1
    Write_Max7219(0x0f, 0x00); //  no test display
}
